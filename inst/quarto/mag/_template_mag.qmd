---
title: "MAG {{< meta mag_id >}}"
params:
  mag_id: "M001"
editor_options: 
  chunk_output_type: console
---

{{< include /_setup.qmd >}}

```{r}
library(tidyverse)
library(gopheR)
```

```{r}
mag_id <- params$mag_id

with_gopher_con(function(c) {
  gopher_query(
    c,
    "
    SELECT *
    FROM mag
    WHERE mag_id = ?
    ",
    params = list(mag_id)
  )
}) |>
  knitr::kable()
```

## Provenance (MAG → Assembly → ReadSets → Samples)

```{r}
with_gopher_con(function(c) {
  gopher_query(
    c,
    "
    SELECT DISTINCT
      REPLACE(m.child_id,  'mag:', '')        AS mag_id,
      REPLACE(m.parent_id, 'assembly:', '')  AS assembly_id,
      REPLACE(a.parent_id, 'read_set:', '')  AS readset_id,
      a.role                                 AS role,
      REPLACE(rs.parent_id,'sample:', '')    AS sample_id,
      REPLACE(s.parent_id, 'site:', '')      AS site,
      samp.collected_date                    AS collected_date
    FROM edge AS m
    JOIN edge AS a
      ON a.child_id = m.parent_id
    JOIN edge AS rs
      ON rs.child_id = a.parent_id
    JOIN edge AS s
      ON s.child_id = rs.parent_id
    JOIN sample AS samp
      ON samp.sample_id = REPLACE(rs.parent_id, 'sample:', '')
    WHERE m.child_id  = ?
      AND m.edge_type = 'binned_from'
      AND a.edge_type = 'assembled_from'
      AND rs.edge_type = 'collected_from'
      AND s.edge_type  = 'sampled_from'
    ORDER BY assembly_id, readset_id, sample_id
    ",
    params = list(paste0("mag:", mag_id))
  )
}) |>
  knitr::kable()
```

## Occurrences (MAG observed in ReadSets / Samples)

```{r}
occ <- with_gopher_con(function(c) {
  gopher_query(
    c,
    "
    SELECT DISTINCT
      ?                                      AS mag_id,
      REPLACE(mrs.parent_id, 'read_set:', '')    AS readset_id,
      REPLACE(rs.parent_id,  'sample:', '')      AS sample_id,
      REPLACE(s.parent_id,   'site:', '')        AS site,
      samp.collected_date                        AS collected_date,
    
      moist.value                                AS moisture,
      moist.unit                                 AS moisture_unit,
    
      mrs.weight                                 AS rel_abundance,
      mrs.evidence                               AS evidence
    
    FROM edge AS mrs                         -- MAG → read_set (occurrence edge)
    
    JOIN edge AS rs
      ON rs.child_id = mrs.parent_id         -- read_set → sample
    
    JOIN edge AS s
      ON s.child_id = rs.parent_id           -- sample → site
    
    JOIN sample AS samp
      ON samp.sample_id = REPLACE(rs.parent_id, 'sample:', '')
    
    LEFT JOIN measurement AS moist
      ON moist.sample_id = samp.sample_id
     AND moist.variable  = 'moisture'
    
    WHERE mrs.child_id  = ?
      AND mrs.parent_id LIKE 'readset:%'
      AND mrs.edge_type = 'observed_in'
      AND rs.edge_type  = 'collected_from'
      AND s.edge_type   = 'sampled_from'
    
    ORDER BY sample_id, readset_id;
    ",
    params = list(mag_id, paste0("mag:", mag_id))
  )
})


occ |>
  knitr::kable()
```

## Environmental context (moisture by sample for this MAG)

```{r}
occ %>%
  distinct(sample_id, moisture, moisture_unit, site) %>%
  arrange(desc(moisture)) |>
  knitr::kable()
```
