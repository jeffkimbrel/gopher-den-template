---
title: "Graph views"
editor_options: 
  chunk_output_type: console
---

{{< include _setup.qmd >}}

```{r}
library(tidyverse)
library(gopheR)
```

This page reads the `edge` table directly to show provenance-style relationships.

```{r}
with_gopher_con(function(c) {
  gopher_query(c, "
    SELECT edge_type, child_uid, parent_uid, role, weight, pipeline_id, created_at
    FROM edge
    ORDER BY edge_type, child_uid
  ")
}) |>
  knitr::kable()
```

## Quick provenance: which assemblies feed which samples?

```{r}
with_gopher_con(function(c) {
  gopher_query(c, "
    SELECT
      substr(e.child_uid, instr(e.child_uid, ':') + 1) AS assembly_id,
      substr(e.parent_uid, instr(e.parent_uid, ':') + 1) AS readset_id,
      e.role,
      r.sample_id,
      s.biome,
      s.site
    FROM edge e
    JOIN read_set r
      ON r.readset_id = substr(e.parent_uid, instr(e.parent_uid, ':') + 1)
    JOIN sample s
      ON s.sample_id = r.sample_id
    WHERE e.edge_type = 'assembled_from'
    ORDER BY assembly_id, readset_id
  ")
}) |>
  knitr::kable()
```

# Graph

```{r}
e = with_gopher_con(function(c) {
  DBI::dbReadTable(c, "edge")}) |>
  tidyr::as_tibble()

graph = e |>
  select(child_uid, parent_uid) %>%
  as.matrix() %>%
  igraph::graph_from_edgelist(directed = T)

df = igraph::V(graph)$name |>
  enframe() |>
  separate(value, into = c("TYPE", "ID"), sep = ":")

igraph::V(graph)$type = df$TYPE
igraph::V(graph)$name = df$ID

igraph::E(graph)$edge_type = e$edge_type

# make a layout so node types stay on the same level
layers <- as.integer(factor(igraph::V(graph)$type, levels = rev(c("sample", "read_set", "assembly", "mag"))))
lay <- igraph::layout_with_sugiyama(graph, layers = layers)$layout

ggraph::ggraph(graph, layout = lay) + # or tree
  ggraph::geom_edge_diagonal(aes(edge_color = igraph::E(graph)$edge_type), linewidth = 2) + 
  ggraph::geom_node_point(size = 12, pch = 21, aes(fill = type)) + 
  ggraph::geom_node_text(aes(label = name), size = 3) +
  scale_fill_brewer(palette = 8) +
  ggraph::scale_edge_color_brewer(palette = 5, direction = 1) +
  ggplot2::coord_flip() +
  ggplot2::theme_void() +
  labs(fill = "Object type", edge_color = "Edge type")
```
