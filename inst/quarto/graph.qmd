---
title: "Graph views"
date: today
editor_options: 
  chunk_output_type: console
---

{{< include _setup.qmd >}}

```{r}
library(tidyverse)
library(gopheR)
```

This page reads the `edge` table directly to show provenance-style relationships.

```{r}
with_gopher_con(function(c) {
  gopher_query(c, "
    SELECT edge_type, child_id, parent_id, role, weight, pipeline_id, created_at
    FROM edge
    ORDER BY edge_type, child_id
  ")
}) |>
  knitr::kable()
```

## Quick provenance: which assemblies feed which samples?

```{r}
gopheR::with_gopher_con(function(c) {
  gopheR::gopher_query(c, "
    SELECT DISTINCT
      REPLACE(a.child_id,  'assembly:', '')  AS assembly_id,
      REPLACE(a.parent_id, 'readset:', '')  AS readset_id,
      a.role                                 AS role,
      REPLACE(rs.parent_id, 'sample:', '')   AS sample_id,
      REPLACE(s.parent_id,  'site:', '')     AS site_id
    FROM edge AS a
    JOIN edge AS rs
      ON rs.child_id = a.parent_id
    JOIN edge AS s
      ON s.child_id = rs.parent_id
    WHERE a.child_id  LIKE 'assembly:%'
      AND a.parent_id LIKE 'readset:%'
      AND a.edge_type = 'assembled_from'
      AND rs.edge_type = 'collected_from'
      AND rs.parent_id LIKE 'sample:%'
      AND s.edge_type  = 'sampled_from'
      AND s.parent_id  LIKE 'site:%'
    ORDER BY assembly_id, readset_id, sample_id, site_id;
  ")
}) |>
  knitr::kable()
```

# Graph

```{r}
e = with_gopher_con(function(c) {
  DBI::dbReadTable(c, "edge")}) |>
  tidyr::as_tibble()

graph = e |>
  select(child_id, parent_id) %>%
  as.matrix() %>%
  igraph::graph_from_edgelist(directed = T)

df = igraph::V(graph)$name |>
  enframe() |>
  separate(value, into = c("TYPE", "ID"), sep = ":")

igraph::V(graph)$type = df$TYPE
igraph::V(graph)$name = df$ID

igraph::E(graph)$edge_type = e$edge_type

# make a layout so node types stay on the same level
layers <- as.integer(factor(igraph::V(graph)$type, levels = rev(c("study", "site", "sample", "readset", "assembly", "mag"))))
lay <- igraph::layout_with_sugiyama(graph, layers = layers)$layout

ggraph::ggraph(graph, layout = lay) + # or tree
  ggraph::geom_edge_diagonal(aes(edge_color = igraph::E(graph)$edge_type), linewidth = 2) + 
  ggraph::geom_node_point(size = 12, pch = 21, aes(fill = type)) + 
  ggraph::geom_node_text(aes(label = name), size = 3) +
  scale_fill_brewer(palette = 8) +
  ggraph::scale_edge_color_brewer(palette = 5, direction = 1) +
  ggplot2::coord_flip() +
  ggplot2::theme_void() +
  labs(fill = "Object type", edge_color = "Edge type")
```
